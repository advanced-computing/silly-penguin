游늯 Test Plan: merge_daily_demand_weather
Function Purpose: Filters EIA data to only include "Demand", calculates the daily average, and merges it with daily weather data using an inner join.

游릭 Test Case 1: Happy Path (Standard Valid Data)
Scenario: The function receives normal hourly EIA data (mix of Actual and Forecast) and normal daily weather data spanning two days.

Input 1 (eia_df): * Jan 1, 10:00 | Demand | 100 MWh

Jan 1, 11:00 | Demand | 200 MWh

Jan 1, 10:00 | Forecast | 999 MWh (Should be filtered out)

Jan 2, 10:00 | Demand | 300 MWh

Jan 2, 11:00 | Demand | 300 MWh

Input 2 (weather_df):

Jan 1 | 15.0 춿C

Jan 2 | 20.0 춿C

Expected Output: A merged DataFrame with exactly 2 rows:

Row 1: Date: Jan 1 | avg_demand_mwh: 150 | avg_temp: 15.0

Row 2: Date: Jan 2 | avg_demand_mwh: 300 | avg_temp: 20.0

游리 Test Case 2: Empty Data (API Failure Simulation)
Scenario: One or both of the APIs failed and returned an empty DataFrame.

Input 1 (eia_df): Empty DataFrame

Input 2 (weather_df): Normal weather data

Expected Output: Empty DataFrame (the function should gracefully exit without crashing Streamlit).

游리 Test Case 3: Missing "Demand" Data
Scenario: The EIA API successfully returns data, but for some reason, it only contains forecast data, no actual "Demand".

Input 1 (eia_df):

Jan 1, 10:00 | Forecast | 500 MWh

Jan 1, 11:00 | Forecast | 550 MWh

Input 2 (weather_df): Normal weather data

Expected Output: Empty DataFrame. (The filter step type-name == "Demand" will leave an empty table, so the final merge should also be empty).

游리 Test Case 4: Unmatched Dates (Inner Join Test)
Scenario: The EIA data and Weather data cover different time ranges. Because the function uses how="inner", it should only keep overlapping dates.

Input 1 (eia_df): Data for Jan 1 and Jan 2.

Input 2 (weather_df): Data for Jan 2 and Jan 3.

Expected Output: A merged DataFrame with exactly 1 row (for Jan 2), as that is the only overlapping date. Jan 1 and Jan 3 are dropped.


游늯 Test Plan: calculate_grid_kpis
Function Purpose: Extracts the latest actual demand and forecast values from a pivoted DataFrame and calculates the forecast error (delta).

游릭 Test Case 1: Happy Path (Standard Valid Data)
Scenario: The function receives a properly formatted DataFrame with both "Demand" and "Day-ahead demand forecast" columns, sorted with the latest data in the first row.

Input (df_pivot): * Row 1 (Latest): Demand = 5000 | Day-ahead demand forecast = 4800

Row 2: Demand = 4900 | Day-ahead demand forecast = 4950

Expected Output: (5000, 4800, 200) (Calculation: 5000 - 4800 = 200)

游리 Test Case 2: Edge Case - Missing Column
Scenario: The API returns incomplete data, resulting in a DataFrame that is missing the "Day-ahead demand forecast" column.

Input (df_pivot):

Row 1: Demand = 5000 | (No forecast column exists)

Expected Output: (None, None, None) (The function should catch the KeyError and fail gracefully without crashing the app).

游리 Test Case 3: Edge Case - Empty DataFrame
Scenario: The function receives a completely empty DataFrame (e.g., due to an API failure upstream or aggressive filtering).

Input (df_pivot): pd.DataFrame() (0 rows, 0 columns)

Expected Output: (None, None, None) (The function should catch the IndexError or check for emptiness and return None values).